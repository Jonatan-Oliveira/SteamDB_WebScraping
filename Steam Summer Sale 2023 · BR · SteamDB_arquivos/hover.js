(function(){"use strict";const E=new Map,R=new Map,i=document.getElementById("js-hover"),D=i.dataset.subhover?".app, .package":".app";let b=null,c=null,v=null,f=null,w=null,U=!0;const d=document.querySelector("#js-screenshots"),_=document.body.dataset.steamCdn,L=new Image;L.fetchpriority="low";let a=null,H=0,u=0;window.SteamDB.RequirePageScreenshotViewer(X,!0),N(),i.addEventListener("pointerenter",K,{passive:!0}),i.addEventListener("pointerleave",m,{passive:!0}),window.SteamDB.BindHover=e=>O(e.querySelectorAll(D)),window.SteamDB.HideHoverIfAny=m,window.SteamDB.ExtensionUserdataLoaded.push(()=>{U=!1});function N(){const e=typeof $=="function"&&typeof $.fn=="object"&&typeof $.fn.dataTable=="function";let t=e?[]:document.querySelectorAll(D);e&&$($.fn.dataTable.tables()).each(function(){t=$(this).DataTable().table().rows(D).nodes().reduce(function(n,r){return n.push(r),n},t),$(this).on("draw.dt",m)}),O(t)}function O(e){for(const t of e)t.addEventListener("pointerenter",j,{passive:!0}),t.addEventListener("pointerleave",Q,{passive:!0})}function j(e){if(e.pointerType!=="mouse"||window.innerWidth<=980)return;if(c){v=e;return}let t="app",o=+e.target.dataset.appid;o||(t="sub",o=+e.target.dataset.subid);let n;if(t==="app"?n=E.get(o):t==="sub"&&(n=R.get(o)),n)return i.appendChild(n),M(n,e.target);b=setTimeout(()=>{let r;t==="app"?r=`/api/RenderAppHover/?appid=${o}`:t==="sub"&&(r=`/api/RenderSubHover/?subid=${o}`),f=new AbortController,fetch(r,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"},signal:f.signal}).then(s=>{if(!s.ok){const l=new Error(`HTTP ${s.status}`);throw l.name="HttpStatusError",l}return s.text()}).then(s=>{if(f=null,i.insertAdjacentHTML("beforeend",s),n=i.firstChild,n){if(t==="app"){E.set(o,n),z(o,n);const l=n.querySelector(".js-open-screenshot-viewer");if(l&&l.dataset.screenshots){const g=l.dataset.screenshots.split(","),q=n.querySelector(".hover_title").textContent;X(l.dataset.appid,q,l,g)}}else t==="sub"&&R.set(o,n);M(n,e.target)}}).catch(s=>{if(!(s.name==="AbortError"||s.name==="HttpStatusError"))throw s})},175)}function m(){if(v=null,b&&(clearTimeout(b),b=null),c&&(clearTimeout(c),c=null),f&&(f.abort(),f=null),w){i.hidden=!0;const e=w.querySelector("video");e&&(e.src="",e.remove()),w.remove(),w=null}}function Q(e){v=null,!c&&(i.contains(e.relatedTarget)||(c=setTimeout(V,100)))}function V(){const e=v;m(),e&&j(e)}function K(){clearTimeout(c),c=null,v=null}function M(e,t){const o=e.querySelector(".hover_video");if(o){const y=document.createElement("video");y.autoplay=!0,y.muted=!0,y.loop=!0,y.src=o.dataset.src,o.appendChild(y)}w=e,i.hidden=!1;const n=t.getBoundingClientRect(),r=document.documentElement.scrollTop,s=n.top+r,l=n.bottom+r,g=n.left+document.documentElement.scrollLeft,q=document.documentElement.clientWidth,T=document.documentElement.clientHeight,W=i.offsetWidth,S=i.offsetHeight,G=q-(g+n.width+W),I=g-W;let p=0;I<0&&G<0?(i.style.left=n.right-W+"px",s+S>T+r&&s-S>=r?p=s-S:p=l):(I<0?i.style.left=g+n.width+"px":i.style.left=I+"px",s+S>T+r?p=T+r-S:p=s),p<1?i.style.top=0:i.style.top=p+"px"}function h(e){u+=e,u<0?u=a.length-1:u%=a.length;let t=a[u];if(t.startsWith("https://")||(t=`${_}steam/apps/${H}/${t}`),d.querySelector(".screenshot-contain").style.backgroundImage=`url(${encodeURI(t)})`,d.querySelector(".screenshot-index").textContent=`${u+1} of ${a.length}`,d.querySelector(".screenshot-open").href=t,a.length>1){e===0&&(e=1);let o=u+e;o<0?o=a.length-1:o%=a.length,t=a[o],t.startsWith("https://")||(t=`${_}steam/apps/${H}/${t}`),L.src=t}}function F(e){e.key==="ArrowLeft"?(e.preventDefault(),h(-1)):e.key==="ArrowRight"||e.key===" "?(e.preventDefault(),h(1)):e.key==="Escape"&&(e.preventDefault(),P())}function P(){document.documentElement.classList.remove("js-screenshots-shown"),document.removeEventListener("keydown",F),a=null,L.src="/static/p.gif"}d.querySelector(".screenshot-prev").addEventListener("click",e=>{e.preventDefault(),h(-1)}),d.querySelector(".screenshot-next").addEventListener("click",e=>{e.preventDefault(),h(1)}),d.querySelector(".screenshot-close").addEventListener("click",e=>{e.preventDefault(),P()}),d.querySelector(".screenshot-contain").addEventListener("click",e=>{e.preventDefault(),h(e.pageX/document.documentElement.clientWidth>=.5?1:-1)});function X(e,t,o,n){const r=s=>{const l=d.querySelector(".screenshot-name");l.textContent=`SteamDB \u2014 ${t}`,l.href=`/app/${e}/`,u=s,H=e,a=n,h(0),document.documentElement.classList.add("js-screenshots-shown"),document.addEventListener("keydown",F)};return o&&o.addEventListener("click",s=>{s.preventDefault(),r(0),m()}),{open:r}}function z(e,t){if(U)return;const o=t.querySelector(".hover_wishlist"),n=t.querySelector(".hover_follow"),r=t.querySelector(".hover_ignore");window.SteamDB.OwnedApps.has(e)?t.querySelector(".hover_owned").hidden=!1:o&&(window.SteamDB.WishedApps.has(e)&&A(o,!0),o.hidden=!1,o.addEventListener("click",s=>{s.preventDefault(),x(o),k(e,window.SteamDB.WishedApps.has(e)?"StoreWishlistRemove":"StoreWishlistAdd")})),n&&(window.SteamDB.FollowedApps.has(e)&&B(n,!0),n.hidden=!1,n.addEventListener("click",s=>{s.preventDefault(),x(n),k(e,window.SteamDB.FollowedApps.has(e)?"StoreUnfollow":"StoreFollow")})),r&&(window.SteamDB.IgnoredApps.has(e)&&C(r,!0),r.hidden=!1,r.addEventListener("click",s=>{s.preventDefault(),x(r),k(e,window.SteamDB.IgnoredApps.has(e)?"StoreUnignore":"StoreIgnore")}))}function x(e){e.innerHTML='<span class="loader"></span>'}function k(e,t){window.postMessage({type:"steamdb:extension-query",contentScriptQuery:t,appid:e},window.location.origin)}function A(e,t){e&&(e.classList.toggle("wished",t),e.textContent=t?"On Wishlist":"Wishlist")}function B(e,t){e&&(e.classList.toggle("followed",t),e.textContent=t?"Unfollow":"Follow")}function C(e,t){e&&(e.classList.toggle("ignored",t),e.textContent=t?"Unignore":"Ignore")}if("BroadcastChannel"in window)try{new BroadcastChannel("steamdb-extension").addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success||!t.data.request.appid)return;const o=E.get(t.data.request.appid);if(!o)return;const n=o.querySelector(".hover_wishlist"),r=o.querySelector(".hover_follow"),s=o.querySelector(".hover_ignore");switch(t.data.request.contentScriptQuery){case"StoreWishlistAdd":A(n,!0);break;case"StoreWishlistRemove":A(n,!1);break;case"StoreFollow":B(r,!0);break;case"StoreUnfollow":B(r,!1);break;case"StoreIgnore":C(s,!0);break;case"StoreUnignore":C(s,!1);break}}})}catch{}})();
