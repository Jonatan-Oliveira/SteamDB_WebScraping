(function(){"use strict";TimeAgo.datetime=function(t){return new Date($(t).attr("data-sort")*1e3)};const j=$("#js-select-tags").multipleSelect({placeholder:"Filter by user tags",countSelected:"# of % user tags",selectAll:!1,filter:!0,onClick:function(t){const e=$(t),s=e.val();e.prop("checked")?s[0]!=="-"&&e.parent().find(".octicon-diff-added").addClass("tag-on"):(e.parent().find(".tag-on").removeClass("tag-on"),s[0]==="-"&&e.val(s.substring(1)))}}),G=j.data("multipleSelect");let S=!0;const C=$('<div class="steamy-checkbox-control checked" id="js-match-all-tags" tabindex="0"><div class="steamy-checkbox"></div><span class="steamy-checkbox-label">Match all included tags</span></div>');C.on("click",function(){return S=!S,C.toggleClass("checked",S),$("#js-filter-submit").prop("disabled",!1),!1}),j.data("match")!=="all"&&(S=!1,C.removeClass("checked")),G.$drop.find(".ms-search").after(C);const R=$("#js-select-categories").multipleSelect({placeholder:"Filter by features",countSelected:"# of % features",selectAll:!1,filter:!0,onClick:function(t){const e=$(t),s=e.val();e.prop("checked")?s[0]!=="-"&&e.parent().find(".octicon-diff-added").addClass("tag-on"):(e.parent().find(".tag-on").removeClass("tag-on"),s[0]==="-"&&e.val(s.substring(1)))}});$(".fancy-select").on("click","label .octicon-diff-removed",function(){const t=$(this),e=t.parent().parent(),s=e.find("input"),n=s.val();n[0]!=="-"&&(e.find(".octicon-diff-added").removeClass("tag-on"),t.addClass("tag-on"),s.val("-"+n).prop("checked",!1))}),$("#js-select-type").multipleSelect({single:!0,selectAll:!1}),$("#js-select-os").multipleSelect({single:!0,selectAll:!1,textTemplate:function(t){let e=t.val();if(e==0)return t.text();let s;switch(e){case"linux":s=999;break;case"macos":s=998;break;case"steamdeck":s=997;break}return e=`<img src="/static/img/categories/${s}.png" width="26" height="16" alt=""> ${t.text()}`,e}}),$("#js-select-cc").multipleSelect({single:!0,selectAll:!1,filter:!0,textTemplate:function(t){let e=t.val();return e==="az"&&(e="cis"),`<img src="/static/country/${e}.svg" class="flag" alt="" width="18" height="18" decoding="async"> ${t.text()}`}});let D;const O=t=>{const e=$(document.body).data("steam-cdn");let s;const n=function(){const a=$(this);a.find(".timeago").each(function(){TimeAgo.init(this)});let o;a.hasClass("package")?o="subs/"+a.data("subid"):o="apps/"+a.data("appid"),a.find(".applogo img").attr("decoding","async").attr("src",e+"steam/"+o+"/capsule_sm_120.jpg?t="+a.data("cache"))},l=function(){const a=(window.innerHeight||document.documentElement.clientHeight)+80,o=t.filter(function(){const d=this.getBoundingClientRect();return d.top>-80&&d.bottom<a&&d.bottom>0});o.each(n),t=t.not(o)};D=()=>{clearTimeout(s),s=setTimeout(l,100)},window.addEventListener("scroll",D,{passive:!0}),window.addEventListener("resize",D,{passive:!0})};$(".applogo img").one("error",function(){$(this).attr("src","/static/img/applogo.svg")}),O($(".app, .package"));let r;const y=$("#js-wishlisted-only");y.on("click",function(){return y.hasClass("disabled")||(r=!r,y.toggleClass("checked",r),r?window.SteamDB.Storage.Set("sales-wishlisted-only",1):window.SteamDB.Storage.Remove("sales-wishlisted-only"),c.draw()),!1});let u;const b=$("#js-followed-only");b.on("click",function(){return b.hasClass("disabled")||(u=!u,b.toggleClass("checked",u),u?window.SteamDB.Storage.Set("sales-followed-only",1):window.SteamDB.Storage.Remove("sales-followed-only"),c.draw()),!1});let f;const x=$("#js-discounts-blue").on("click",function(){return f=!f,x.toggleClass("checked",f),f?window.SteamDB.Storage.Set("sales-blue-discounts-only",1):window.SteamDB.Storage.Remove("sales-blue-discounts-only"),c.draw(),!1});let g;const T=$("#js-discounts-green").on("click",function(){return g=!g,T.toggleClass("checked",g),g?window.SteamDB.Storage.Set("sales-green-discounts-only",1):window.SteamDB.Storage.Remove("sales-green-discounts-only"),c.draw(),!1});let m;const E=$("#js-discounts-minor").on("click",function(){return m=!m,E.toggleClass("checked",m),m?window.SteamDB.Storage.Set("sales-minor-discounts-only",1):window.SteamDB.Storage.Remove("sales-minor-discounts-only"),c.draw(),!1});let h;const v=$("#js-hide-owned-games");v.on("click",function(){return v.hasClass("disabled")||(h=!h,v.toggleClass("checked",h),h?window.SteamDB.Storage.Set("sales-hide-owned-games",1):window.SteamDB.Storage.Remove("sales-hide-owned-games"),c.draw()),!1});let w;const k=$("#js-hide-ignored-games");k.on("click",function(){return k.hasClass("disabled")||(w=!w,k.toggleClass("checked",w),w?window.SteamDB.Storage.Set("sales-hide-ignored-games",1):window.SteamDB.Storage.Remove("sales-hide-ignored-games"),c.draw()),!1}),SteamDB.ExtensionUserdataLoaded.push(()=>{y.removeClass("disabled tooltipped"),b.removeClass("disabled tooltipped"),v.removeClass("disabled tooltipped"),k.removeClass("disabled tooltipped"),window.SteamDB.Storage.Get("sales-wishlisted-only")&&(r=!0,y.addClass("checked")),window.SteamDB.Storage.Get("sales-followed-only")&&(u=!0,b.addClass("checked")),window.SteamDB.Storage.Get("sales-hide-ignored-games")&&(w=!0,k.addClass("checked")),c.rows(".package").every(function(){let t=!1;const e=this.node(),s=e.dataset.apps.split(",");delete e.dataset.apps;for(const n of s){const l=Number(n);if(window.SteamDB.FollowedApps.has(l)&&e.classList.add("followed"),window.SteamDB.WishedApps.has(l)&&(e.classList.add("wished"),!t)){t=!0;const a=this.cell(this,0),o=a.node();o.dataset.sort=Number(o.dataset.sort)+9,a.invalidate()}window.SteamDB.IgnoredApps.has(l)&&e.classList.add("ignored")}return!0}),c.rows(".app").every(function(){const t=this.node(),e=Number(t.dataset.appid);if(window.SteamDB.WishedApps.has(e)){let s=10;t.querySelector(".highest-discount-major")?s=30:t.querySelector(".highest-discount")&&(s=20);const n=this.cell(this,0),l=n.node();l.dataset.sort=Number(l.dataset.sort)+s,n.invalidate()}else if(window.SteamDB.OwnedApps.has(e)){const s=this.cell(this,0),n=s.node();n.dataset.sort=Number(n.dataset.sort)-5,s.invalidate()}return!0}),c.draw()}),window.SteamDB.Storage.Get("sales-hide-owned-games")&&(h=!0,v.addClass("checked")),window.SteamDB.Storage.Get("sales-blue-discounts-only")&&(f=!0,x.addClass("checked")),window.SteamDB.Storage.Get("sales-green-discounts-only")&&(g=!0,T.addClass("checked")),window.SteamDB.Storage.Get("sales-minor-discounts-only")&&(m=!0,E.addClass("checked")),$.fn.dataTableExt.afnFiltering.push(function(t,e,s){const n=t.aoData[s].nTr;if(f||g||m){const l=!!n.querySelector(".price-discount-major"),a=!!n.querySelector(".price-discount-minor"),o=!!n.querySelector(".price-discount"),d=(l?1:0)|(o?2:0)|(a?4:0),B=(f?1:0)|(g?2:0)|(m?4:0);if(!(d&B))return!1}if(r||u){const l=n.classList.contains("wished"),a=n.classList.contains("followed");if(!l&&!a||r!==l&&u!==a)return!1}return!(w&&n.classList.contains("ignored")||h&&n.classList.contains("owned"))});const q=$("#js-sales-count"),i=$("#js-filters");i.on("submit",function(){i.find(".fancy-price-input").filter(function(s,n){return $(n).val()<=0}).prop("disabled",!0),i.find("input[name=max_reviews]").filter(function(s,n){return $(n).val()<=0}).prop("disabled",!0),i.find("select").filter(function(s,n){return n=$(n),n.val()==n.data("default")}).prop("disabled",!0);const t=j.prop("disabled",!0).multipleSelect("getSelects");t.length>0&&($("<input>").attr({type:"hidden",name:"tagid",value:t.join(",")}).appendTo(i),S||$("<input>").attr({type:"hidden",name:"any_tag",value:"1"}).appendTo(i));const e=R.prop("disabled",!0).multipleSelect("getSelects");if(e.length>0&&$("<input>").attr({type:"hidden",name:"category",value:e.join(",")}).appendTo(i),i.find(".fancy-price-input:not(:disabled)").length>0&&i.find("#js-select-cc").prop("disabled",!1),document.getElementById("js-filter-loader").hidden=!1,document.getElementById("js-app").hidden=!0,i.serialize().length===0)return window.location.href="/sales/",!1}).find("select, input").one("change",function(){$("#js-filter-submit").prop("disabled",!1)}),$("#js-filters-reset").on("click",function(){document.getElementById("js-filter-loader").hidden=!1,document.getElementById("js-app").hidden=!0}),$("#js-input-rating").on("input",function(){$("#js-value-rating").text($(this).val())}),$("#js-input-discount").on("input",function(){const t=$(this).val(),e=$("#js-value-discount");e.text(t>0||e.data("zero")?`\u2265${t}`:`>${t}`)}),$(".steamy-checkbox-control").on("keypress",function(t){t.keyCode===32&&(t.preventDefault(),$(this).trigger("click"))});const A=document.getElementById("steamdb-extension-protip");A&&A.addEventListener("toast-close",()=>{try{window.sessionStorage.setItem("extension_protip_hidden","1")}catch{}});let p=$("#js-sale-countdown");if(p.length&&p.data("target")){const t=p.data("target");let e=null,s,n,l,a;p=p.find(".sale-timer");const o=function(B,_){return B+" "+_+(B==1?"":"s")},d=function(){if(s=t-new Date().getTime(),s<0){clearInterval(e),p.text("Valve time");return}l=0|s%36e5/6e4,a=0|s%6e4/1e3,s>36e5?n=o(0|s/36e5,"hour")+", ":n="",n+=o(l,"minute")+" and "+o(a,"second"),p.text(n)};d(),e=setInterval(d,1e3)}const I=document.querySelector(".table-sales");if(!I){document.getElementById("js-app").hidden=!1,document.getElementById("js-filter-loader").hidden=!0;return}const N=document.getElementById("js-select-type").value;let L=[[0,"desc"],[5,"desc"],[3,"desc"]];N==="OwnedGames"&&(L=[[5,"desc"]]);const c=$(I).DataTable({orderClasses:!1,autoWidth:!1,pageLength:100,stripeClasses:[],lengthMenu:[[25,50,100,250,1e3,5e3,-1],[25,50,100,250,"1K","5K","All (slow)"]],columnDefs:[{orderSequence:["desc","asc"],targets:[3,5,7,8]}],aaSorting:L,initComplete:function(){document.getElementById("js-app").hidden=!1,document.getElementById("js-filter-loader").hidden=!0},drawCallback:function(){q.text(this.api().page.info().recordsDisplay.toLocaleString()),D()}}).on("page.dt",function(){document.querySelector(".table-container").scrollIntoView({behavior:"smooth",block:"start"})})})();
